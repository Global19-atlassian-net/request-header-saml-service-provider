# README #

This Docker image is used for SAML authentication.

# OpenShift Instructions #
The deployment of this pod involves loading a template and using it to create a
new application.  This running pod will mount in secrets for all custom
configuration.

## Create place to store SAML config files and this project
```
SAML_CONFIG_DIR=~/saml-config
mkdir $SAML_CONFIG_DIR
pushd $SAML_CONFIG_DIR
git clone https://github.com/openshift/request-header-saml-service-provider.git
popd
```

## SAML Metadata
Create the secret for the httpd saml configuration files (saml-sp.cert,
saml-sp.key, saml-sp.xml, sp-idp-metadata.xml).

The `mellon_create_metadata.sh` script takes two parameters
* `ENTITY-ID` - An ID unique to your IDP. By convention this should resolve to your meta data file. In the case of the Apache Mellon container created by this project that would be `https://APPLICATION_DOMAIN/mellon/metadata`
   * `APPLICATION_DOMAIN` is the FQDN of the route for your Apache Mellon service created via this project
* `ENDPOINT-URL` - The end point of the Apache Mellon service which based on the template created in this project would be  `https://APPLICATION_DOMAIN/mellon`
  * `APPLICATION_DOMAIN` is the FQDN of the route for your Apache Mellon service created via this project

Given this the metadata can be generated by doing the following

```
pushd ~/saml-config
mkdir ./httpd-saml-config
pushd httpd-saml-config

mellon_create_metadata.sh https://APPLICATION_DOMAIN/mellon/metadata https://APPLICATION_DOMAIN/mellon

# Note, Secrets cannot have key names with an 'underscore' in them, so when
# creating metadata files with `mellon_create_metadata.sh` the resulting files
# must be renamed appropriately.
mv saml_sp.cert saml-sp.cert
mv saml_sp.key saml-sp.key
mv saml_sp.xml saml-sp.xml
popd
popd
```

The sp-idp-metadata.xml must be supplied by your [Identity Provider](keycloak/testing_with_keycloak.md#creating-the-saml-metadata).


```sh
oc secrets new httpd-saml-config-secret ./httpd-saml-config
```


## Authentication certificate
This certifcate is used by the saml service provider pod to make a secure
request to the Master.  Using all the defaults a suitable file can be created
as follows:

```
oc adm create-api-client-config
  --certificate-authority='/etc/origin/master/ca.crt' \
  --client-dir='/etc/origin/master/proxy' \
  --signer-cert='/etc/origin/master/ca.crt' \
  --signer-key='/etc/origin/master/ca.key' \
  --signer-serial='/etc/origin/master/ca.serial.txt' \
  --user='system:proxy'

pushd ~/saml-config
mkdir ./httpd-ose-certs
cat /etc/origin/master/proxy/system\:proxy.crt /etc/origin/master/proxy/system\:proxy.key > ./httpd-ose-certs/authproxy.pem
cp /etc/origin/master/ca.crt httpd-ose-certs/ca.crt
popd
```

Now create the secret:

```sh
oc secrets new httpd-ose-certs-secret ./httpd-ose-certs
```

The saml service provider pod will itself expose a TLS endpoint.  The OpenShift
Router will use TLS passthrough to allow it to terminate the connection. 

__NOTE__: these instructions use the OCP CA to sign the cert. The other option is to get your own signed certificate.
```sh
mkdir ./httpd-server-certs

oc adm ca create-server-cert \
  --signer-cert='/etc/origin/master/ca.crt' \
  --signer-key='/etc/origin/master/ca.key' \
  --signer-serial='/etc/origin/master/ca.serial.txt' \
  --hostnames='APPLICATION_DOMAIN' \
  --cert=./httpd-server-certs/server.crt \
  --key=./httpd-server-certs/server.key
```
* `APPLICATION_DOMAIN` is the FQDN of the route for your Apache Mellon service created via this project

Now create the client certs secret:
```sh
oc secrets new httpd-server-certs-secret ./httpd-server-certs
```

Create a secret for the CA (secret and cert names must be unique)
__NOTE__: if using your owned signed cert then replace the OpenShift CA path with your CA.
```sh
oc secrets new httpd-server-ca-cert-secret /etc/origin/master/ca.crt
```

### Making changes to secrets
It's likely you will need to update the value of some secrets.  To do this
simply delete the secret and recreate it.  Then trigger a new deployment.

```
oc delete secret <secret name>
oc secrets new <secret name> <path>
oc rollout latest saml-auth
```

### Deploying the image
Add saml-auth template to OSE - (required parameters: APPLICATION_DOMAIN, PROXY_PATH, PROXY_DESTINATION)
```sh
oc create -f ./saml-auth.template -n openshift
```

Create a new application (test with '-o json', remove when satisfied with the result)
```sh
oc new-app saml-auth \
    -p APPLICATION_DOMAIN=sp.example.org -p PROXY_PATH=/oauth/ -p PROXY_DESTINATION=https://ose.example.com:8443/oauth/ -o json
```

### Mounting the secrets

Mount the secret for the SAML configuration (saml-sp.cert,saml-sp.key,saml-sp.xml,sp-idp-metadata.xml)
```sh
oc volume deploymentconfigs/saml-auth \
     --add --overwrite --name=httpd-saml-config --mount-path=/etc/httpd/conf/saml \
     --type=secret --secret-name=httpd-saml-config-secret
```

Mount the secret for OSE certs (authproxy.pem,ca.crt)
```sh
oc volume deploymentconfigs/saml-auth \
     --add --overwrite --name=httpd-ose-certs --mount-path=/etc/httpd/conf/ose_certs \
     --type=secret --secret-name=httpd-ose-certs-secret
```

Mount the secret for server certs (server.crt,server.key)
```sh
oc volume deploymentconfigs/saml-auth \
     --add --overwrite --name=httpd-server-certs --mount-path=/etc/httpd/conf/server_certs \
     --type=secret --secret-name=httpd-server-certs-secret
```

Mount the secret for the CA cert (duplicate as required)
__NOTE__: if using your owned signed cert then replace the OpenShift CA path with your CA.
```sh
oc volume deploymentconfigs/saml-auth \
     --add --overwrite --name=httpd-server-ca-cert --mount-path=/etc/pki/ca-trust/source/anchors/ca-cert.crt \
     --type=secret --secret-name=httpd-server-ca-cert-secret
```

The template defines replicas as 0.  This pod can be scaled to multiple
replicas for high availability.
```sh
oc scale --replicas=1 dc saml-auth
```

After that command runs you will likely see several deployments for each of the
volumes that are mounted.

### Master configuration changes.

Update /etc/origin/master/master-config.yaml:
```
oauthConfig:
  assetPublicURL: https://ose.example.com:8443/console/
  grantConfig:
    method: auto
  identityProviders:
  - name: saml
    challenge: false
    login: true
    mappingMethod: add
    provider:
      apiVersion: v1
      kind: RequestHeaderIdentityProvider
      loginURL: "https://sp.example.org/oauth/authorize?${query}"
      clientCA: /etc/origin/master/ca.crt
      headers:
      - Remote-User
  masterCA: ca-bundle.crt
...

```

```
assetConfig:
  logoutURL: "https://sp.example.org/mellon/logout?ReturnTo=https://sp.example.org/logged_out.html"
```

Restart the master(s) at this point for the configuration to take effect.

### Making local modifications

#### ImageStream preparation
If building the image locally or pulling from another location it's helpful to
create an ImageStream to simplify ongoing deployments.  As the cluster-admin
this can be accomplished as follows:

```
# create a project for hosting the images
oc new-project openshift3

# allow all authenticated users to pull this image
oadm policy add-cluster-role-to-group system:image-puller system:authenticated -n openshift3

```

At this point you can either manually build the image or pull it from another location.

### Manually building the docker image
Create the docker image
```sh
docker build --tag=saml-service-provider .
```

#### Pushing the image to the internal docker registry

Since the builder service account has access to create ImageStreams in the
`openshift3` project we can use its token.

```
docker login -u unused -e unused -p `oc sa get-token builder -n openshift3` 172.30.36.214:5000

# Find the internal registry IP or use DNS. In this example 172.30.36.214 is
# the internal registry.
oc get services | grep docker-registry
docker tag <your.local.image/saml-service-provider> 172.30.36.214:5000/openshift3/saml-service-provider
docker push 172.30.36.214:5000/openshift3/saml-service-provider

# If this is your first time deploying the saml pod you will need to manually scale up
oc scale --replicas=1 dc saml-auth

```
